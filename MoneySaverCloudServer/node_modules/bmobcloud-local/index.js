var __modules = {}

__modules.oData = require("./lib/bmob-cloud-data.js");

__modules.oPush = require("./lib/bmob-cloud-push.js");
__modules.oRelation = require("./lib/bmob-cloud-relation.js");
__modules.oFile = require("./lib/bmob-cloud-file.js");
__modules.oFunctions = require("./lib/bmob-cloud-functions.js");
__modules.oAtom = require("./lib/bmob-cloud-atom.js");
__modules.oBatch = require("./lib/bmob-cloud-batch.js");
__modules.oArray = require("./lib/bmob-cloud-array.js");
__modules.oLocation = require("./lib/bmob-cloud-location.js");

__modules.oAsync = require("./lib/bmob-cloud-async.js");
__modules.oEncodeing = require("./lib/bmob-cloud-encoding.js");
__modules.oEvent = require("./lib/bmob-cloud-event.js");
__modules.oHtmlparser = require("./lib/bmob-cloud-htmlparser.js");
__modules.oHttp = require("./lib/bmob-cloud-http.js");
__modules.oMail = require("./lib/bmob-cloud-mail.js");

var common = require("./bmob-cloud-common.js");
var Bmob = __modules.Bmob = common.Bmob;

var http = require("http");
var util = require("util");

var model = {};

model.initialize = function (app_key, rest_key) {
    Bmob.initialize(app_key, rest_key);
}

var port = 30000;
var testOld = model.testOld = function (onRequest, requestParam, done) {
    var cPort = port++;
    var server = http.createServer(function (req, response) {
        req.setEncoding('utf-8');//设置编码

        var postData = "";
        req.addListener('data', function (postDataStream) {
            postData += postDataStream
        });

        req.addListener('end', function () {
            //数据接收完毕
            if (postData) {
                var param = JSON.parse(postData);
                req.body = param;
            }
            onRequest(req, response, __modules);
        });

    }).listen(cPort);

    var request = http.request({
        'host': 'localhost',
        'port': cPort,
        'path': '/',
        'method': 'POST'
    });
    if (requestParam)
        request.write(JSON.stringify(requestParam));
    request.end();

    request.on('response', function (response) {
        response.on('data', function (data) {
            console.log(util.format('nodejs Response Body\n{ \n"code": %s, \n"msg": \n%s \n}', response.statusCode, data))
            server.close();

            (done || function(){console.log("\n--------------------\n");})();
        });
    });
}

// just support exports one!!!
model.test = function (file, requestParam, done) {
    var one;
    if (typeof file == "function") {
        one = file;
    } else {
        var group = require(file);
        var name;
        for (one in group) {
            name = one;
        }

//        console.log(group[name].toString());
        one = group[name]
    }

    testOld(one, requestParam, done);
}

model.testInServer = function (file, requestParam, done) {
    var code = require(file);
    var name;
    for (one in code) {
        name = one;
    }

    if (name) {
        var run = function () {
            __modules.oFunctions.run(
                {"name": name, "data": requestParam || {}},
                function (err, resp) {
                    console.log(resp || err);
                    done && done();
                }
            );
        }

        var pub = require("./pub.js");
        pub(file, run);
    }
}

module.exports = model;
